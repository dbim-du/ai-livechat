<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:lang('添加分组')}</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="__STATIC__/admin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__STATIC__/admin/style/admin.css" media="all">
</head>
<body>
<input type="hidden" id="posturl" value="{$sysconfigList[2]['web_url']}">
<input type="hidden" id="loginDify_PassWord" name="loginDify_PassWord" value="{$loginDify_PassWord}">
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-tab layui-tab-brief">
                    <ul class="layui-tab-title">
                        <li class="layui-this">{:lang('弹层接入')}</li>
                        <li>{:lang('固定连接接入')}</li>
                        <li>{:lang('指定客服模式')}</li>
                    </ul>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="layui-card-body">
                                <h3>
                                    {:lang('在您要接入的网站内添加如下的代码：')}
                                    请选择应用：
                                    <select id="glyy_tcjr" onchange="createWebUrl('tcjr')">
                                    </select>
                                    (已发布的应用)
                                </h3>
                                <pre class="layui-code"><p>&lt;script src="{$domain}/index/index/chatBoxJs/appcode/<span id="appcode_tcjr"></span>/u/{$seller_code}"&gt;&lt;/script&gt;</p><p>&lt;script&gt;ServiceChat.init();&lt;/script&gt;</p></pre>
                                <h3>{:lang('则会在您的网站上显示蓝色的，咨询客服按钮。')}</h3>
                                <br/>
                                <ul class="site-doc-bgcolor">
                                    <li class="layui-bg-red" style="padding: 10px">！如果你们的网站有自己的 用户id 、用户名、头像信息，您可以通过如下方式传入</li>
                                </ul>
                                <pre class="layui-code"><p>&lt;script src="{$domain}/index/index/chatBoxJs/appcode/<span id="appcode_tcjr_"></span>/u/{$seller_code}"&gt;&lt;/script&gt;</p><p>&lt;script&gt; ServiceChat.init({uid: xxx, uName: xxx, avatar: xxx}); &lt;/script&gt;</p></pre>
                                <table class="layui-table">
                                    <thead>
                                    <tr>
                                        <th>{:lang('参数')}</th>
                                        <th>{:lang('解释')}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>uid</td>
                                        <td>访客的唯一标识，可以是你网站的用户id 或者 其他标识，不传系统自动生成 uuid</td>
                                    </tr>
                                    <tr>
                                        <td>uName</td>
                                        <td>访客的昵称，不传的话，系统自动会拼接 '访客' + uid</td>
                                    </tr>
                                    <tr>
                                        <td>avatar</td>
                                        <td>访客的头像，即您网站的用户头像, 不传默认是系统的通用头像</td>
                                    </tr>
                                    </tbody>
                                </table>
                                <p>{:lang('系统默认的用户信息如下：')}</p>
                                <pre class="layui-code"><p>uid = '3pbzowjtbz0000'; </p><p>uName = '访客3pbzowjtbz0000'; </p><p>avatar = 'http://xxx.com__STATIC__/common/images/customer.png';</p></pre>
                            </div>
                        </div>
                        <div class="layui-tab-item">
                            <div class="layui-tab-item layui-show">
                                <div class="layui-card-body">
                                    <h3>
                                        {:lang('你可以在任何地方通过调用如下的连接：')}
                                        
                                        请选择应用：
                                        <select id="glyy" onchange="createWebUrl('gdljjr')">
                                        </select>
                                        (已发布的应用)

                                    </h3>
                                    <pre class="layui-code"><p>{$domain}/kefu/<span id="appcode"></span>/{$seller_code}</p></pre>
                                    <h3>{:lang('就会显示一个固定了宽的聊天页面。')}</h3>
                                    <br/>
                                    <ul class="site-doc-bgcolor">
                                        <li class="layui-bg-red" style="padding: 10px">{:lang('我这里限制了宽，如果您觉得不合适，可以自己进行修改。另外暂时不支持。')}</li>
                                    </ul>
                                    <br/>
                                    <h3>从 v2.1.6 版本之后，加入可传访客信息的接口,您可以通过如下的接口传入访客的信息：</h3>
                                    <pre class="layui-code"><p>{$domain}/index/index/kefu?appcode=<span id="appcode_"></span>&u={$seller_code}&uid=xxx&name=xxx&avatar=xxx</p></pre>
                                    <table class="layui-table">
                                        <thead>
                                        <tr>
                                            <th>{:lang('参数')}</th>
                                            <th>{:lang('解释')}</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td>uid</td>
                                            <td>访客的唯一标识，可以是你网站的用户id 或者 其他标识，不传系统自动生成 uuid</td>
                                        </tr>
                                        <tr>
                                            <td>name</td>
                                            <td>访客的昵称，不传的话，系统自动会拼接 '访客' + uid</td>
                                        </tr>
                                        <tr>
                                            <td>avatar</td>
                                            <td>访客的头像，即您网站的用户头像, 不传默认是系统的通用头像</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="layui-tab-item">
                            <div class="layui-tab-item layui-show">
                                <div class="layui-card-body">
                                    <h3>{:lang('你可以在任何地方通过在固定连接后面添加客服的标识，实现接入指定客服的功能：')}</h3>
                                    <table class="layui-table">
                                        <thead>
                                        <tr>
                                            <th>{:lang('客服名称')}</th>
                                            <th>{:lang('站点名称')}</th>
                                            <th>{:lang('站点域名')}</th>
                                            <th>{:lang('访问连接')}</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {foreach name="kefu" item="vo"}
                                        <tr>
                                            <td>{$vo['kefu_name']}</td>
                                            <td>{$vo['web_name']}</td>
                                            <td>{$vo['web_url']}</td>
                                            <td>{$domain}/kefu/{$seller_code}/{$vo['kefu_code']}/{$vo['web_code']}</td>
                                        </tr>
                                        {/foreach}
                                        </tbody>
                                    </table>
                                    <ul class="site-doc-bgcolor">
                                        <li class="layui-bg-orange" style="padding: 10px">考虑到您可能在别处批量调用客服，而不是一个个粘贴，特提供如下接口。 均为 GET 请求,返回json</li>
                                    </ul>
                                    <table class="layui-table">
                                        <thead>
                                        <tr>
                                            <th>{:lang('接口名称')}</th>
                                            <th>{:lang('接口地址')}</th>
                                            <th>{:lang('参数')}</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- <tr>
                                            <td>{:lang('获取指定分组下的客服')}</td>
                                            <td>{$domain}/index/api/getSellerKeFuByGroup/seller_code/{$seller_code}/group_id/xxx</td>
                                            <td>xxx {:lang('处替换为 分组')}ID</td>
                                        </tr> -->

                                        <tr>
                                            <td>{:lang('获取指定分组下的客服')}</td>
                                             <td>{$domain}/index/api/getSellerKeFuByGroup/appcode/<span id="appcode_zdkfms"></span></td>
                                            <td>
                                                请选择应用：
                                                <select id="glyy_zdkfms" onchange="createWebUrl('zdkfms')">
                                                </select>
                                                (已发布的应用)
                                            </td>
                                        </tr>

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="__STATIC__/admin/layui/layui.js"></script>
<script src="__STATIC__/common/js/jquery.min.js"></script>
<script>
    layui.config({
        base: '__STATIC__/admin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index']);
</script>

<!-- 预请求 dify 数据 -->
<script>
    
    var dify_token = "";

    loginDify();
    // 1、dify 测试登录
    function loginDify()
    {
        $.ajax({
            url: $('#posturl').val()+'/console/api/login', 
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({ 
                email: localStorage.getItem('email'),
                password: $('#loginDify_PassWord').val(),
                language:'zh-Hans',
                remember_me:true
            }),
            success: function(response) {
                // console.log(' 请求成功:', response);
                dify_token = response.data.access_token;
                getDifyAppList(response.data.access_token);
            },
            error: function(xhr, status, error) {
                console.error(' 请求失败:', error);
            }
        });
    }

    // 2、获取 dify 应用列表
    function getDifyAppList(dify_token)
    {

        var posturl = $("posturl").val();
        $.ajax({
            url: $('#posturl').val()+'/console/api/apps?page=1&limit=100&name=&is_created_by_me=true', 
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + dify_token //access_token
            },
            success: function(response) {
                // console.log('1、请求成功:', response);

                var html = '';
                response.data.forEach(element => {
                    if (element.workflow != null) {
                        html+="<option value='" + element.id + "'>" + element.name + "</option>";
                    }
                });
                document.getElementById('glyy').innerHTML = html;
                document.getElementById('glyy_tcjr').innerHTML = html;
                document.getElementById('glyy_zdkfms').innerHTML = html;
                // 动态生成表单元素后需要重新渲染 
                layui.use('form',  function(){
                    var form = layui.form; 
                    form.render();  // 更新渲染 
                });

                // 3、选择应用 后 生成 对应的 固定连接
                createWebUrl("tcjr");

                // 固定连接接入
                createWebUrl("gdljjr");

                // 指定客服模式
                createWebUrl("zdkfms");
            },
            error: function(xhr, status, error) {
                console.error(' 请求失败:', status, error);
            }
        });

    }

    // 3、选择应用 后 生成 对应的 固定连接 / 弹层接入
    function createWebUrl(glyy)
    {
        
        
        var url = "";
        if (glyy == "tcjr") {
            url = $('#posturl').val()+'/console/api/apps/'+$('#glyy_tcjr').val();
        }
        if (glyy == "gdljjr") {
            url = $('#posturl').val()+'/console/api/apps/'+$('#glyy').val();
        }
        if (glyy == "zdkfms") {
            url = $('#posturl').val()+'/console/api/apps/'+$('#glyy_zdkfms').val();
        }

        console.log(url);

        $.ajax({
            url: url, 
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + dify_token //access_token
            },
            success: function(response) {
                if (glyy == "tcjr") {
                    $("#appcode_tcjr").html(response.site.access_token);
                    $("#appcode_tcjr_").html(response.site.access_token);
                }
                if (glyy == "gdljjr") {
                    $("#appcode").html(response.site.access_token);
                    $("#appcode_").html(response.site.access_token);
                }
                if (glyy == "zdkfms") {
                    $("#appcode_zdkfms").html(response.site.access_token);
                }
                
                console.log("返回结果：" + response.site.access_token);
                
            },
            error: function(xhr, status, error) {
                console.error('2、请求失败:', status, error);
            }
        });



    }

</script>

</body>
</html>
